# Making up to data vector
File system layout for use in the OTA

The systemfs /src/bin folder

    ssh
    update-engine

Note: ssh copied, update engine edited

the  /etc changes
 - iptables
 - ssh
 custom ssh

Copied
    bin
     webserver

## Preparing a better OTA file

Preparation of files
1. Create updated installer file, that does not verify, and doesn't do a password check
2. Create a new ssh key, ssh file, with authorized,
3. Merge the 1.1 files and the 1.7 to get a new one 1.7.rcm.ota

Will use a file structure for the custom stuff to add to modern things:

    bootfs
        /release
        /src
        /tools
    systemfs
        /release
        /src
        /tools


### Extract the originals

1. Extract the OTAs
2. Copy useful stuff from 1.1 to the hierarchy
   - /etc/ ssh
   - ssh
   - /etc/ iptables
   - /anki/bin webserver
   - anki resources webserver
3. Make edits
    boot init
    update-engine
4. Create new SSH stuff
    Puttygen keys
    put into ssh config

Update engine
    things to watch out for
     - DO NOT do a differential update
     - DO not do an ABOOT update


1. Extract the OTAs
2. Copy 1.7 as baseline
3. Copy useful stuff from 1.1 to dest
4. Edit the updater script
5. update the version
5. Update the boot command line
6. Repack
7. Update the 

Edit the comment line to remove dm-verity
- we can't just use the 1.7 boot and ramdisk, it has dm-verity
- we can't use the 1.1 aboot, as it has an older kernel and dfu
- there may be other ankidev images with the right bootloader, I just got tired

### Update the systemfs

The steps to merge 1.1's SSH & Webserver into the 1.7:

    mount /dev/sda1 /media/usb
    cd /media/usb1
    gunzip 1.1.img.gz
    gunzip 1.7.img.gz
    cp 1.7.img dest.img
    
    mkdir -p /tmp/1.1
    mkdir -p /tmp/dest
    mount -o loop,ro,sync 1.1.img /tmp/1.1
    mount -o loop,rw,sync dest.img /tmp/dest
    cd /tmp/1.1

#### Update the update-engine

edit the /anki/bin/update-engine
or copy the attached one

edit the /etc/version
or copy the attached one

#### Copy the iptables
#### The secure shell

    cp -r etc/ssh /tmp/dest/etc
    cp lib/systemd/system/ss* /tmp/dest/lib/systemd/system

#### Copy the webserver
    cp anki/bin/vic-webserver /tmp/dest/anki/bin
    cp anki/etc/vic-webserver.env /tmp/dest/anki/etc
    /tmp/1.7/anki/data/assets/cozmo_resources
    cp -r  /tmp/1.1/anki/data/assets/cozmo_resources/webserver /tmp/dest/anki/data/assets/cozmo_resources

edit the start so that 

## Deployment
Steps
1. Downgrade to 1.1 dev
2. On BLE inject new keys
3. Login
4. Put new, updated installer file in there.
5. Download the new 1.7.rcm.ota
6. Login



# crafting the ota
## modify the manifest
In

    [SYSTEM]
    encryption=0
    [BOOT]
    encryption=0
